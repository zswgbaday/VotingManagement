<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zsw.dao.mappers.RoleMapper">
    

    <resultMap id="roleResultMap" type="com.zsw.pojo.role.Role" >
        <id column="id" property="id" jdbcType="NUMERIC" javaType="Integer"></id>
        <result column="name" property="name" jdbcType="VARCHAR" javaType="String"></result>
        <result column="icon" property="icon" jdbcType="VARCHAR" javaType="String"></result>
        <association property="resources" 
                     column="roleId=id"
                     javaType="list"
                     select="com.zsw.dao.mappers.ResourcesMapper.findResourcesByRoleId" ></association>
    </resultMap>
    
    <sql id="roleCol">
        id, name, icon
    </sql>
    
    <select id="findRoleByRoleId" resultMap="roleResultMap" >
        select 
         <include refid="roleCol" />
        from v_role role where id = #{roleId} 
    </select>
    
    <select id="findRolesByUserId" resultMap="roleResultMap" >
        select 
        <include refid="roleCol"/>
        from v_relation_user_role relation inner join v_role role on relation.role_id = role.id
        where relation.user_id = #{userId}
    </select>
    
    <!--查询所有role-->
    <select id="findRoles" resultMap="roleResultMap">
    <bind name="offsetNum" value="(page - 1) * size"></bind>
        select <include refid="roleCol"/> from v_role
        <if test="keyWord != null">
            where name like concat("%",#{keyWord},"%")
        </if>
        limit #{offsetNum} , #{size}
    </select>
    
    <delete id="deleteRelationUserByUserId" flushCache="true" parameterType="String">
        delete from v_relation_user_role
        where v_relation_user_role.user_id = #{userId}
    </delete>
    
    <!--创建新角色-->
    <insert id="insertNewRole" parameterType="com.zsw.pojo.role.Role">
        insert into v_role(name, icon) values(#{name}, #{icon, jdbcType=VARCHAR})
    </insert>
    
    <!--更新角色-->
    <update id="updateRole" parameterType="com.zsw.pojo.role.Role">
        update v_role set id = id
        <if test="name != null">
            , name = #{name}
        </if>
        <if test="icon != null">
            , icon = #{icon, jdbcType=VARCHAR}
        </if>
        where id = #{id}
    </update>
    
    <!--删除角色-->
    <delete id="deletRole" parameterType="Integer">
        delete from v_role where id = #{id}
    </delete>
    
</mapper>